<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Source Code | swpd.me]]></title>
  <link href="http://swpd.github.io/blog/categories/source-code/atom.xml" rel="self"/>
  <link href="http://swpd.github.io/"/>
  <updated>2013-09-16T09:44:15+08:00</updated>
  <id>http://swpd.github.io/</id>
  <author>
    <name><![CDATA[swpd]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Monkey HTTP Daemon Internals]]></title>
    <link href="http://swpd.github.io/blog/2013/05/18/monkey-http-daemon-internals/"/>
    <updated>2013-05-18T09:21:00+08:00</updated>
    <id>http://swpd.github.io/blog/2013/05/18/monkey-http-daemon-internals</id>
    <content type="html"><![CDATA[<p><img src="/images/blog/monkey.jpg" title="&lsquo;Go! Monkey!&rsquo; &lsquo;Go! Monkey!&rsquo;" ></p>

<h2>Table of Contents</h2>

<ul>
<li><a href="#intro">Introduction</a></li>
<li><a href="#data">Basic Data Structures</a></li>
<li><a href="#workflow">Brief Workflow</a></li>
<li><a href="#config">Configuration</a></li>
<li><a href="#sched">Scheduler</a></li>
<li><a href="#clock">Clock</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#http">HTTP Requests and Responses</a></li>
<li><a href="#api">API Exposure</a></li>
<li><a href="#plugins">Plugins</a></li>
<li><a href="#appendix">Appendix</a></li>
</ul>


<h2>Introduction<a id='intro'></a></h2>

<p><a href="http://monkey-project.com">Monkey HTTP Daemon</a> is a web server that aims to get
the most out of the Linux platform. It comes with low resource comsumption and
great scalability which makes it a perfect solution for embedded devices.</p>

<p>Due to the compact size of Monkey&rsquo;s codebase, it is a proper place for revealing
the internals of a event-driven HTTP web server. Spending some time on analysing
the source code of Monkey will surely worth the cost.</p>

<p>This post is about the internals of Monkey&rsquo;s critical components from the
perspective of source code, you may consider it as a supplement of <a href="http://edsiper.linuxchile.cl/blog/2013/02/27/architecture-of-a-linux-based-web-server/">this
post</a>
(written by the author of Monkey). You are supposed to read it first to get a
general view of Monkey.</p>

<p><strong>Notice</strong>: This post is based on Monkey 1.2.0, you may want to get the latest code.
(check out <a href="http://monkey-project.com">home page</a> for more information). If you
are using an older version, there might be something different, e.g. red-black
tree is introduced since version 1.2.0.</p>

<!-- more -->


<h2>Basic Data Structures<a id='data'></a></h2>

<p>This section discusses some common data structures used in Monkey. It is relatively
independent and fundamental so I put it as first.</p>

<ul>
<li><h3>Circular Doubly Linked List</h3></li>
</ul>


<p>Linked List is heavily used within Monkey&rsquo;s source code. It is used to maintain
a list of given structures.</p>

<p>The definition of List is given by <code>mk_list.h</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">mk_list</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Pretty simple and straight forward. But wait for a minute, where is the payload
of a list node? Aha, the list used in Monkey is like the one used in Linux kernel.
The payload of a list node is not held inside the <code>mk_list</code> structure, on the
contrary a list node is embedded in a <em>host structure</em> (see Figure 1-1).</p>

<p><img src="/images/blog/linked-list.png" title="&lsquo;Circular Doubly Linked List&rsquo; &lsquo;Figure 1-1 Circular Doubly Linked List&rsquo;" ></p>

<p>Taken <code>mk_config_entry</code> structure(from <code>mk_config.h</code>) as an example, it contains
a <code>mk_list</code> which is used to connect configuration entries together:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">mk_config_entry</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>As you may have noticed, there&rsquo;s an extra <code>mk_list</code> in Figure 1-1 that acts as a
sentinel node. This convention simplifies list handling by ensuring that the list
always has a <em>first</em> and <em>last</em> node(even with a empty list). When initializing a
list, Monkey takes a sentinel node and set its <code>prev</code> and <code>next</code> fields to point
to the node itself:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mk_list_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">list</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">next</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'><span class="n">list</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Besides some common list processing functions, there are some handy macros for
list manipulation(<code>mk_config.h</code>):</p>

<p><code>mk_list_foreach(curr, head)</code>: iterate a given list and do something with every
node of the list. <code>curr</code> is a temporary <code>mk_list</code> pointer used to hold the current
visited node. <code>head</code> is the pointer to the head of the given list.</p>

<p><code>mk_list_foreach_safe(curr, n, head)</code>: iterate a given list and do some delete
operation to the node of the list. <code>curr</code> is a temporary <code>mk_list</code> pointer used to
hold the current visited node. Another <code>mk_list</code> temporary pointer <code>n</code> is needed to
retrieve the next node of <code>curr</code> in advance because <code>curr</code> is no longer exists
before the next iteration. <code>head</code> is the pointer to the head of the given list.</p>

<p><code>mk_list_entry(ptr, type, member)</code>: get the start address of a <em>host structure</em>
of a given list node. <code>ptr</code> is a pointer to a given <code>mk_list</code> node. <code>type</code> is the
type of the <em>host structure</em>. <code>member</code> is the name of <code>mk_list</code> field within the
<em>host structure</em>.</p>

<p>Example Usage:
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'> <span class="o">*</span> <span class="n">assume</span> <span class="n">the</span> <span class="n">type</span> <span class="n">of</span> <span class="n">host</span> <span class="n">structure</span> <span class="n">is</span> <span class="n">banana</span>
</span><span class='line'> <span class="o">*</span> <span class="k">struct</span> <span class="n">banana</span> <span class="p">{</span>
</span><span class='line'> <span class="o">*</span>     <span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'> <span class="o">*</span>     <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'> <span class="o">*</span> <span class="p">};</span>
</span><span class='line'> <span class="o">*</span> <span class="n">monkey</span> <span class="n">loves</span> <span class="n">bananas</span> <span class="o">:</span><span class="n">D</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">banana</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mk_list_foreach</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">bananas</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">mk_list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">banana</span><span class="p">,</span> <span class="n">_head</span><span class="p">);</span>
</span><span class='line'><span class="cm">/* do something with b */</span>
</span><span class='line'><span class="n">wash</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mk_list_foreach_safe</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">bananas</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">mk_list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">banana</span><span class="p">,</span> <span class="n">_head</span><span class="p">);</span>
</span><span class='line'><span class="cm">/* delete from the list */</span>
</span><span class='line'><span class="n">mk_list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">b</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">_head</span><span class="p">);</span>
</span><span class='line'><span class="cm">/* do some delete operation */</span>
</span><span class='line'><span class="n">eat</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li><h3>String</h3></li>
</ul>


<p>String is the most common data structure used in Monkey, and how it is represented
will affect the efficiency and size of Monkey. As we know, the major target of
Monkey is embedded devices so every byte counts.</p>

<p>There are two types of string representation used in Monkey, one is the native
<code>char *</code>(a.k.a. null-terminated) and the other one is defined as <code>mk_pointer</code>
(<code>mk_memory.h</code>):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span> <span class="n">mk_pointer</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The main difference between them is: the string that referred by one <code>mk_pointer</code>
may also be shared by other <code>mk_pointer</code>(see Figure 1-2) while a <code>char *</code> string
normally have a standalone copy.</p>

<p>By using <code>mk_pointer</code> we can save some memory allocation and release by reusing
the same string. This technique can also reduce memory usage and make Monkey more
compact.</p>

<p><img src="/images/blog/pointer.png" title="&lsquo;String used by multi mk_pointer&rsquo; &lsquo;Figure 1-2 String used by multi mk_pointer&rsquo;" ></p>

<p>When we need to make some change to a given string that is shared by some
<code>mk_pointer</code>, we may not manipulate in the origin string, instead we duplicate a
separate copy. Otherwise it may change some <code>mk_pointer</code> silently which can lead
to unexpected result. <code>char *mk_pointer_to_buf(mk_pointer p)</code> is responsible for
this job. It takes a <code>mk_pointer</code> as input and return a newly allocated string,
the caller shall free the string after use.</p>

<ul>
<li><h3>Red-Black Tree</h3></li>
</ul>


<p>Searching is a common task for almost every program. In Monkey, we will need to
look up the relative information frequently given a socket file descriptor. If
we used list to organize our data, we can only do a linear search because list is
out of order.</p>

<p>In the worst case(the one we are looking for is the last), we need to travel
through the whole list. This is an O(N) operation and as list size increases
this maybe unacceptable for a high performance web server. And this is why
reb-black tree is introduced into Monkey.</p>

<p>If you are unfamiliar with red-black tree, it is time to pick up your undergraduate
data structure textbook and have a quick review. Or alternatively you may refer
to <a href="http://en.wikipedia.org/wiki/Red%E2%80%93black_tree">wikipedia</a> for introduction.</p>

<p><img src="/images/blog/rbtree.png" title="&lsquo;Red-Black Tree&rsquo; &lsquo;Figure 1-3 Red-Black Tree&rsquo;" ></p>

<p>The definition of red-black tree is given by <code>mk_rbtree.h</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">rb_node</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">rb_parent_color</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">RB_RED</span>      <span class="mi">0</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">RB_BLACK</span>    <span class="mi">1</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">attribute</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))));</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="cm">/* The alignment might seem pointless, but allegedly CRIS needs it */</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>As with <code>mk_list</code>, an <code>mk_rbtree</code> node is also embedded in a <em>host structure</em>.</p>

<h2>Brief Workflow<a id='workflow'></a></h2>

<p>Before we dive into the nitty-gritty of Monkey, it is helpful to walk through the
main function(<code>monkey.c</code>) to get a first impression of Monkey.</p>

<p><img src="/images/blog/bootup.jpg" title="&lsquo;Monkey Bootup&rsquo; &lsquo;Figure 2-1 Money Bootup&rsquo;" >
Main function demonstrates the workflow of Monkey in a high level view:</p>

<ul>
<li>As most traditional Unix program, Monkey starts with parsing command line
options, the options are all very self-explanatory. Use <code>monkey -h</code> to get full
description of options.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">DSvhp</span><span class="o">:</span><span class="n">w</span><span class="o">:</span><span class="n">c</span><span class="o">:&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="n">long_opts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;v&#39;</span>:
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>After parsing options Monkey sets up signal handlers for its interesting signals
and leave others as default (<code>mk_signals.c</code>).</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_signals_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey builds a configuration for itself, some entries of the configuration may
be overrided by the previous parsed options. For more details of the building
process please refer to <em><a href="#config">Configuration</a></em> section.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_config_start_configure</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey allocates an array <code>sched_list</code> of type <code>sched_list_node</code>(defined in
<code>mk_scheduler.h</code>) for worker management. For example, when choosing a worker to
handle a new user request, Monkey&rsquo;s scheduler uses the information maintained by
<code>sched_list</code>.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_sched_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey starts to load the plugins enabled by user and read extra plugin
configurations. For more details of plugins please refer to <em><a href="#plugins">Plugins</a></em>
section.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_plugin_init</span><span class="p">();</span>
</span><span class='line'><span class="n">mk_plugin_read_config</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey creates listening socket and binds it to default port <code>2001</code>(if not
overrided).</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Server</span> <span class="n">listening</span> <span class="n">socket</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">server_fd</span> <span class="o">=</span> <span class="n">mk_socket_server</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">serverport</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">listen_addr</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey process will turn into a daemon if it is started in daemon mode.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Running</span> <span class="n">Monkey</span> <span class="n">as</span> <span class="n">daemon</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">is_daemon</span> <span class="o">==</span> <span class="n">MK_TRUE</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">mk_utils_set_daemon</span><span class="p">();</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey then creates a pid file(<code>logs/monkey.pid.2001</code> by default) which contains
the process identification number (pid) of itself. Pid file is used for
administrating Monkey later.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Register</span> <span class="n">PID</span> <span class="n">of</span> <span class="n">Monkey</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_utils_register_pid</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey sets the timestamp of when it is started and set up two formatted human
readable time strings, one is for logger and the other is for HTTP response headers.
This must be done before any threads are created, otherwise some thread may
execute before the start time recorded by Monkey.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Clock</span> <span class="n">init</span> <span class="n">that</span> <span class="n">must</span> <span class="n">happen</span> <span class="n">before</span> <span class="n">starting</span> <span class="n">threads</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_clock_sequential_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Once timestamp is set, Monkey can start the clock thread. The clock thread will
run in an infinite loop and update the two time strings mentioned above per second.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_utils_worker_spawn</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">mk_clock_worker_init</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey creates some thread specific keys for later use by HTTP workers, such as
<code>worker_sched_node</code> for scheduling client connections, etc.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Init</span> <span class="kr">thread</span> <span class="n">keys</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_thread_keys_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>If Monkey is started by root user, it will set the uid/gid to the user specified
in configuration.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Change</span> <span class="n">process</span> <span class="n">owner</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_user_set_uidgid</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Check if the effective user of Monkey can set the <code>O_NOATIME</code> flag for file accessing.
If so, Monkey will request Linux not to update the last access time on the file.
Updating last access time makes hardly any sence as normally a web server just
send the contents of files requested by clients back.  This will improve Monkey&rsquo;s
performance because we can save a lot of time for very often accessed files.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_config_sanity_check</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey invokes process hooks(<code>PRCTX</code>) of all the plugins, this is useful for
plugins to set up something before entering the main infinite loop. For example,
a plugin may require Monkey to spawn an independent thread for it.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Invoke</span> <span class="n">Plugin</span> <span class="n">PRCTX</span> <span class="n">hooks</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_plugin_core_process</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey spawns HTTP worker threads for HTTP requests handling. The number of
workers is specified in configuration, if the number is 0 Monkey will spawn HTTP
workers depending on the cores of your CPU(one worker per core).</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Launch</span> <span class="n">monkey</span> <span class="n">http</span> <span class="n">workers</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_server_launch_workers</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey waits for all HTTP worker threads to be ready by checking the <code>initialized</code>
field of all worker schedule nodes(<code>sched_list_node</code>) every 10 milliseconds. The
mutex lock <code>mutex_worker_init</code> is used to synchronize the status of workers, this
ensures the status of workers won&rsquo;t change during the checking process. Once all
threads are marked as ready the mutex lock is no longer necessary, making the
following server loop lock-free.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">all</span> <span class="n">workers</span> <span class="n">report</span> <span class="n">as</span> <span class="n">ready</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">mutex_worker_init</span><span class="p">);</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">workers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">initialized</span><span class="p">)</span>
</span><span class='line'>        <span class="n">ready</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">mutex_worker_init</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">workers</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* wait for 10 milliseconds */</span>
</span><span class='line'><span class="n">usleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Monkey enters the main loop of server(<code>mk_server.c</code>), starts listening for
incoming sockets and then dispatches them to workers for processing. From now on,
Monkey is good and ready! It will keep serving requests until you tell it to exit.</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_server_loop</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">server_fd</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Configuration<a id='config'></a></h2>

<p>Configuration makes Monkey easier to tweak and more flexible, this section will
demonstrate how Monkey deal with it.</p>

<ul>
<li><h3>Configuration File Format</h3></li>
</ul>


<p>Monkey uses a hunman readable file format for configuration, the file is
line-oriented and uses indent level for hierarchy. Figure 3-1 shows the hierarchy
of a configuration file. Within the file there are one or more <em>sections</em>, under
every section there are one or more <em>entries</em>. Besides these there are comments,
comments are lines that start with sharp mark(<code>#</code>).</p>

<p><img src="/images/blog/config.png" title="&lsquo;Configuration File Format&rsquo; &lsquo;Figure 3-1 Configuration File Format&rsquo;" ></p>

<p>A section groups some relative entries for certain subject, and an entry represents
a key-value pair. Section sould be surrounded by brackets(<code>[]</code>) and every entry&rsquo;s
key and value are separated by a whitespace. Monkey comes with comprehensive
configuration documentation, you may want to check out <code>conf/monkey.conf</code> for more
details about how every entry affect Monkey&rsquo;s behaviour.</p>

<ul>
<li><h3>File to Memory Mapping</h3></li>
</ul>


<p>Before Monkey starts serving, it first parse some configuration files to construct
corresponding structures(<code>mk_config</code>, defined in <code>mk_config.h</code>) that resides in
memory. Once parse is finished, Monkey can speed up configuration information
accessing by reading directly from memory.</p>

<p>For every hierarchy level of a Monkey configuration file, there is a mapping
structure in <code>mk_config.h</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'> <span class="o">*</span>          <span class="n">hierarchy</span> <span class="n">level</span> <span class="n">mapping</span>
</span><span class='line'> <span class="o">*</span>
</span><span class='line'> <span class="o">*</span> <span class="n">configuration</span> <span class="n">file</span>      <span class="o">===&gt;</span>    <span class="n">mk_config</span>
</span><span class='line'> <span class="o">*</span> <span class="n">section</span>                 <span class="o">===&gt;</span>    <span class="n">mk_config_section</span>
</span><span class='line'> <span class="o">*</span> <span class="n">entry</span><span class="p">(</span><span class="n">key</span><span class="o">-</span><span class="n">value</span> <span class="n">pair</span><span class="p">)</span>   <span class="o">===&gt;</span>    <span class="n">mk_config_entry</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">created</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* list of sections */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">sections</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config_section</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* list of entries */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">entries</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config_entry</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>A bunch of functions(in <code>mk_config.c</code>) are used for handling configuration file:</p>

<p><code>mk_config_create</code>: given the location of a configuration file, allocate a brand
new <code>mk_config</code>. For every section found in the file allocate a <code>mk_config_section</code>
and for every entry allocate a <code>mk_config_entry</code>.  All the <code>mk_config_section</code> are
linked together as a linked list, the <code>sections</code> field of <code>mk_config</code> serves as the
sentinel node of the list and every <code>_head</code> field of <code>mk_config_section</code> is a
list node. The relation between <code>entries</code> field of <code>mk_config_section</code> and <code>_head</code>
field of <code>mk_config_entry</code> are likewise.</p>

<p><code>mk_config_section_add</code>: add a <code>mk_config_section</code> to the section list of a
specified <code>mk_config</code>. Used by <code>mk_config_create</code> to construct section list.</p>

<p><code>mk_config_section_get</code>: given a section name, find the pointer to the corresponding
<code>mk_config_section</code>.</p>

<p><code>mk_config_entry_add</code>: add a <code>mk_config_entry</code> to the entry list of a specified
<code>mk_config_section</code>. Used by <code>mk_config_create</code> to construct entry list.</p>

<p><code>mk_config_section_getval</code>: given a <code>mk_config_section</code> and a key, find the entry
matching the key under the section. If an entry is found, return its value field,
otherwise return <code>NULL</code>. There are several types of entry value: string, number,
boolean and list. We need to specify which type will the value be interpreted,
and Monkey will parse the value string to correct type for us, the type codes is
defined as follows(<code>mk_config.h</code>):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">MK_CONFIG_VAL_STR</span> <span class="mi">0</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">MK_CONFIG_VAL_NUM</span> <span class="mi">1</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">MK_CONFIG_VAL_BOOL</span> <span class="mi">2</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">MK_CONFIG_VAL_LIST</span> <span class="mi">3</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Example Usage:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mk_config_section_getval</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Port</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="n">MK_CONFIG_VAL_NUM</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>mk_config_error</code>: raise configuration parsing error message and exit Monkey.</p>

<p><code>mk_config_free</code>: free all the allocated resource for a specified <code>mk_config</code>.</p>

<p><code>mk_config_free_entries</code>: free all the allocated resource for a specified
<code>mk_config_section</code>.</p>

<ul>
<li><h3>Virtual Hosting Configuration</h3></li>
</ul>


<p>Monkey supports virtual hosting, which makes it possible for a single server to
host separate host names and share resources among these hosts. For more detailed
introduction please refer to Monkey&rsquo;s <a href="http://monkey-project.com/documentation/virtual_hosts">documentation</a>.</p>

<p>Monkey requires every virtual host to have an independent host configuration file
and all the entries are under a single section <code>[HOST]</code>. All the host configuration
files are under <code>conf/sites/</code>, by default, there is only a file named <code>default</code>.
Every host is represented as a <code>host</code> structure within Monkey(<code>mk_config.h</code>):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">host</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>                   <span class="cm">/* configuration file location*/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">server_names</span><span class="p">;</span>  <span class="cm">/* host names (a b c...) */</span>
</span><span class='line'><span class="n">mk_pointer</span> <span class="n">documentroot</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">host_signature</span><span class="p">;</span>
</span><span class='line'><span class="n">mk_pointer</span> <span class="n">header_host_signature</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>     <span class="cm">/* source configuration */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">error_pages</span><span class="p">;</span>   <span class="cm">/* custom error pages */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>         <span class="cm">/* link node */</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>file</code> denotes the host file location of current <code>host</code>, <code>server_names</code> is a list
of host names(every host name is a <code>host_alias</code>), <code>documentroot</code> is the document
directory path that is treated by current <code>host</code> as root directory,
<code>host_signature</code> stores the web server name of current <code>host</code>, <code>header_host_signature</code>
is similar to <code>host_signature</code> except that it is formatted as a HTTP header field,
<code>config</code> is undoubtedly the memory mapping of the host configuration file,
<code>error_pages</code> is a list of pages to be displayed when certain HTTP error is
encountered.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Virtual</span> <span class="n">host</span> <span class="n">name</span> <span class="p">,</span> <span class="n">every</span> <span class="k">virtual</span> <span class="n">host</span> <span class="n">may</span> <span class="n">contain</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="n">of</span> <span class="n">this</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">host_alias</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Custom</span> <span class="n">error</span> <span class="n">page</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">error_page</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">short</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>       <span class="cm">/* HTTP error code */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>             <span class="cm">/* file location relative to documentroot */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">real_path</span><span class="p">;</span>        <span class="cm">/* absolute location of file in the file system */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>All the host configuration information can be found in <code>config</code> field, and why
do we need other fields? There are three reasons for doing so:</p>

<ol>
<li>some fields require further parsing, such as <code>server_names</code> is a list built
from the plain text value of entry <code>Servername</code>.</li>
<li>stores the entry value in a field can make code for retrieving entry value
shorter.</li>
<li>some fields can only be evaluated when Monkey is running.</li>
</ol>


<p>In Monkey we use <code>mk_config_get_host</code> to get a <code>host</code> from a host configuration
file path.</p>

<ul>
<li><h3>Server Configuration</h3></li>
</ul>


<p>Once we gain the necessary knowledge, we can start our journey to Monkey&rsquo;s global
server configuration. The main server configuration is defined in <code>mk_config.h</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="k">struct</span> <span class="n">server_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And the <code>server_config</code> structure is a bit larger than anyone we have encountered
so far, thus it is not appropriate to display all the fields of <code>server_config</code>
here and only those really matter will be listed(a reader clever like you can
easily figure out what the rest fields mean by their names :D):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">server_config</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">server_fd</span><span class="p">;</span>                <span class="cm">/* server socket file descriptor */</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">worker_capacity</span><span class="p">;</span> <span class="cm">/* how many clients per thread */</span>
</span><span class='line'><span class="kt">short</span> <span class="kt">int</span> <span class="n">workers</span><span class="p">;</span>            <span class="cm">/* number of worker threads */</span>
</span><span class='line'><span class="kt">int8_t</span> <span class="n">is_daemon</span><span class="p">;</span>             <span class="cm">/* start Monkey as a daemon process */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">serverconf</span><span class="p">;</span>             <span class="cm">/* path to server configuration files */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">listen_addr</span><span class="p">;</span>            <span class="cm">/* address to listen, 0.0.0.0(all) by default */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">pid_file_path</span><span class="p">;</span>          <span class="cm">/* pid of server */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">pid_status</span><span class="p">;</span>               <span class="cm">/* whether pid file is created */</span>
</span><span class='line'><span class="kt">int8_t</span> <span class="n">resume</span><span class="p">;</span>                <span class="cm">/* allow file range(partial contents)? */</span>
</span><span class='line'><span class="kt">int8_t</span> <span class="n">symlink</span><span class="p">;</span>               <span class="cm">/* allow symbolic link requests? */</span>
</span><span class='line'><span class="kt">int8_t</span> <span class="n">keep_alive</span><span class="p">;</span>            <span class="cm">/* allow persisten connection? */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">max_keep_alive_request</span><span class="p">;</span>   <span class="cm">/* max persistent connections to allow */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">keep_alive_timeout</span><span class="p">;</span>       <span class="cm">/* persistent connection timeout */</span>
</span><span class='line'><span class="n">uid_t</span> <span class="n">euid</span><span class="p">;</span>                   <span class="cm">/* effective user id */</span>
</span><span class='line'><span class="n">gid_t</span> <span class="n">egid</span><span class="p">;</span>                   <span class="cm">/* effective group id */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">index_files</span><span class="p">;</span>  <span class="cm">/* different index file names */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">hosts</span><span class="p">;</span>         <span class="cm">/* list of virtuals hosts served by Monkey */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">plugins</span><span class="p">;</span>      <span class="cm">/* plugins enabled by Monkey */</span>
</span><span class='line'>                              <span class="cm">/* ...(some omitted fields) */</span>
</span><span class='line'><span class="n">mode_t</span> <span class="n">open_flags</span><span class="p">;</span>            <span class="cm">/* flags used to open files that required by clients */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">safe_event_write</span><span class="p">;</span>         <span class="cm">/* safe EPOLLOUT event */</span>
</span><span class='line'><span class="cm">/* Transport type: HTTP or HTTPS, useful for redirections */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* Define the plugin which provides the transport layer */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">transport_layer</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">plugin</span> <span class="o">*</span><span class="n">transport_layer_plugin</span><span class="p">;</span>
</span><span class='line'><span class="cm">/* Define the default MIME type when it is not possible to find a proper one */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">default_mimetype</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now let&rsquo;s take a closer look at how server configuration is built by Monkey:</p>

<ul>
<li><p>As we have seen in the <a href="#workflow"><em>Brief Workflow</em></a> section, Monkey enters server
configuration building process via <code>mk_config_start_configure</code>. Before reading
configuration file into memory, Monkey initializes some fields of <code>server_config</code>
with default values(by calling <code>mk_config_set_init_values</code>).</p></li>
<li><p>Monkey then uses <code>mk_config_read_files</code> to map the server configuration file
into memory(<code>config</code> field of <code>server_config</code>). If an entry is defined in the
file, its default value will be overrided:</p></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">in</span> <span class="n">function</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">mk_config_set_init_values</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="n">MK_TRUE</span><span class="p">;</span>   <span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="k">default</span> <span class="n">value</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">in</span> <span class="n">function</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">mk_config_read_files</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">overrided</span> <span class="n">by</span> <span class="n">configuration</span> <span class="n">file</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">mk_config_section_getval</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">KeepAlive</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>                                                   <span class="n">MK_CONFIG_VAL_BOOL</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li><p>After the main configuration file is parsed, Monkey starts mapping all the
virtual host configuration files into memory. This is achieved by calling
<code>mk_config_read_hosts</code>, it will go through all the files under <code>conf/sites/</code>(except
<code>.</code>, <code>..</code> and <code>default</code>, <code>default</code> has been read before any virtual hosts) and
construct the corresponding <code>host</code>(<code>mk_config_get_host</code>). All the <code>host</code> are linked
together as a list via the <code>hosts</code> field of <code>server_config</code>.</p></li>
<li><p>Monkey reads the MIME types configuration file(<code>conf/monkey.mime</code>) and stores
all the types in an array for later use. For more details of MIME types please
refer to <a href="#http"><em>HTTP</em></a> section.</p></li>
</ul>


<p>Up to this point, the configuration building process of Monkey is finished.</p>

<h2>Scheduler<a id='sched'></a></h2>

<p>Recall that Monkey spawns several HTTP workers for client requests processing,
one thing we might concern about is how Monkey will schedule a new incoming
connection. With this question in mind, let&rsquo;s dig into Monkey&rsquo;s scheduler strategy
and implementation.</p>

<p>Within Monkey the scheduling unit is abstracted as structure <code>sched_connection</code>
(defined in <code>mk_scheduler.h</code>).</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">sched_connection</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>              <span class="cm">/* file descriptor of remote socket */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">status</span><span class="p">;</span>              <span class="cm">/* connection status */</span>
</span><span class='line'><span class="kt">uint32_t</span> <span class="n">events</span><span class="p">;</span>         <span class="cm">/* epoll events that Monkey is intereted about */</span>
</span><span class='line'><span class="kt">time_t</span> <span class="n">arrive_time</span><span class="p">;</span>      <span class="cm">/* arrived time(when a connection is established) */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">rb_node</span> <span class="n">_rb_head</span><span class="p">;</span> <span class="cm">/* red-black tree head(for quick accessing) */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>    <span class="cm">/* list head */</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>When a client issues a new connection to the Monkey server, a new socket file
descriptor is associated with it. Then Monkey will schedule this connection based
on a simple load balance strategy: find the HTTP worker that holds the least active
connections and dispatch the new connection to it. Although this is a trivial
strategy, it works fine because mostly HTTP request processing and response
generating won&rsquo;t take a long time. But if there is an HTTP request requires enormous
amount of computation, other requests handled by the same worker will wait for a
long time while other workers may be idle.</p>

<p>In order to schedule connections, Monkey needs to keep track of some extra information
of every HTTP worker. For every HTTP worker, there is a associated <code>sched_list_node</code>
(defined in <code>mk_scheduler.h</code>) structure for the sake of maintaining such information:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">sched_list_node</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">accepted_connections</span><span class="p">;</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Red-Black tree queue to perform fast lookup over</span>
</span><span class='line'><span class="cm"> * the scheduler busy queue</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">rb_root</span> <span class="n">rb_queue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Available and busy queue */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">busy_queue</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">av_queue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">short</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="cm">/* worker index */</span>
</span><span class='line'><span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span> <span class="cm">/* worker thread id */</span>
</span><span class='line'><span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>     <span class="cm">/* worker process id, thread is just light weight process in Linux */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">epoll_fd</span><span class="p">;</span>  <span class="cm">/* epoll instance for monitoring file descriptors */</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">initialized</span><span class="p">;</span> <span class="cm">/* whether this worker has been initialized */</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>accepted_connections</code> records the total number of connections accepted and
hanlded by the corresponding worker, and <code>closed_connections</code> records the total
number of connections closed by the corresponding worker. With these two numbers
the active connections of a worker is given by the difference of them:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">the</span> <span class="n">active</span> <span class="n">connection</span> <span class="n">number</span> <span class="n">will</span> <span class="n">never</span> <span class="n">be</span> <span class="n">negative</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">active_connections</span> <span class="o">=</span> <span class="n">accepted_connections</span> <span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span> <span class="n">closed_connections</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>rb_queue</code> refers to the root of a red-black tree that maintains all the active
connections of the corresponding worker according to their file descriptors. The
<code>_rb_head</code> field of active <code>sched_connection</code> serve as tree nodes and are linked
together as a red-black tree.</p>

<p><code>busy_queue</code> is a linked list of used scheduling connection nodes while <code>av_queue</code>
is a linked list of available scheduling connection nodes.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_next_target</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* calculate the active connections of worker */</span>
</span><span class='line'><span class="n">cur</span> <span class="o">=</span> <span class="n">sched_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">accepted_connections</span> <span class="o">-</span> <span class="n">sched_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Finds the worker with lowest load */</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">workers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">accepted_connections</span> <span class="o">-</span> <span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">target</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>        <span class="n">cur</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * If sched_list[target] worker is full then the whole server too, because</span>
</span><span class='line'><span class="cm"> * it has the lowest load.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">mk_unlikely</span><span class="p">(</span><span class="n">cur</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">worker_capacity</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;Too many clients: %i&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">worker_capacity</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">workers</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>As we can see above, Monkey will go through the <code>sched_list_node</code> array in order
to pick up the worker with lowest load and return its index.</p>

<p>When the socket is finally established, a new <code>sched_connection</code> structure is
allocated for the socket to maintain some connection related information. All the
scheduling units of a worker are pre-allocated as the maximum connection number
a worker is able to handle is already known. What can we benefit from this strategy?
If we allocate a new <code>sched_connection</code> every time a new connection comes and
release the structure when the request reaches its end, it will generate some
overhead. For a high loads Monkey instance, this may result in a degradation of
performance.</p>

<p>When a worker is lauched by Monkey, an array of <code>sched_connection</code> structures are
initialized and all the elements of that array are linked to the <code>av_queue</code> list
of the worker (function <code>mk_sched_register_thread</code> in <code>mk_scheduler.c</code>).</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Start</span> <span class="n">filling</span> <span class="n">the</span> <span class="n">array</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="n">mk_mem_malloc_z</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sched_connection</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">worker_capacity</span><span class="p">);</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">worker_capacity</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">sched_conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'><span class="n">sched_conn</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MK_SCHEDULER_CONN_AVAILABLE</span><span class="p">;</span>
</span><span class='line'><span class="n">sched_conn</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">socket</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="n">sched_conn</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">arrive_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mk_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sched_conn</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sl</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">av_queue</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>If a new <code>sched_connection</code> is required, the worker will remove one from the
<code>av_queue</code> and add it to the <code>busy_queue</code> (function <code>mk_sched_register_client</code> in
<code>mk_scheduler.c</code>).  If all the available nodes are used, the new connection will
be dropped by Monkey.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sched_conn</span> <span class="o">=</span> <span class="n">mk_list_entry_first</span><span class="p">(</span><span class="n">av_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sched_connection</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">head</span><span class="p">);</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">Move</span> <span class="n">to</span> <span class="n">busy</span> <span class="n">queue</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="n">mk_list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sched_conn</span><span class="o">-&gt;&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">head</span><span class="p">);</span>
</span><span class='line'><span class="n">mk_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sched_conn</span><span class="o">-&gt;</span><span class="n">_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">sched</span><span class="o">-&gt;</span><span class="n">busy_queue</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Figure 4-1 shows a possible layout of the array and how the scheduling connection
nodes are linked together by two queues.</p>

<p><img src="/images/blog/scheduling_connection_list.jpg" title="&lsquo;Scheduling Connection List&rsquo; &lsquo;Figure 4-1 Scheduling Connection List&rsquo;" ></p>

<ul>
<li><h3>Epoll</h3></li>
</ul>


<p>As we have mentioned above, Monkey is an event-driven web server and the I/O event
notification facility used by it is <code>epoll</code> (Linux-specific).</p>

<p>For every worker thread spawned by Monkey, there is an epoll instance for monitoring
socket file descriptors that are dispatched it. When a new connection is accepted
by Monkey, the socket fd is first dispatched to the worker with lowest load and
added to its epoll instance (see <code>mk_sched_add_client</code> function in <code>mk_scheduler.c</code>
for more information).</p>

<p>The main loop of every worker then waits for events that occurs on the socket fds that
it is responsible to monitor, and processes the events properly by using the event
handler of the sockets. According to the event types, different routines of the
event handler will be called. When read event is fired on the socket, the read
routine of event handler will be called, and when it is a write event, the
corresponding write routine will be called, etc. (Of course there can be one than
one events occur on a single socket fd simultaneously)</p>

<p>Source code never lies (see <code>mk_epoll_init</code> in <code>mk_epoll.c</code>):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">worker</span> <span class="kr">thread</span> <span class="n">main</span> <span class="n">loop</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * wait for upcoming events.</span>
</span><span class='line'><span class="cm"> * notice: the timeout of epoll_wait is defined as MK_EPOLL_WAIT_TIMEOUT,</span>
</span><span class='line'><span class="cm"> * currently the value is 3000 milliseconds, that is 3 seconds, if not any</span>
</span><span class='line'><span class="cm"> * events are fired after 3 seconds after the last check, the worker will</span>
</span><span class='line'><span class="cm"> * quit waiting and check if it needs to close some sockets due to their</span>
</span><span class='line'><span class="cm"> * timeouts.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="n">num_fds</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">efd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">max_events</span><span class="p">,</span> <span class="n">MK_EPOLL_WAIT_TIMEOUT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">num_fds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fd</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* call the corresponding handler routine */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;[FD %i] EPoll Event READ&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">read</span><span class="p">)</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;[FD %i] EPoll Event WRITE&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">EPOLLHUP</span> <span class="o">|</span> <span class="n">EPOLLERR</span> <span class="o">|</span> <span class="n">EPOLLRDHUP</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;[FD %i] EPoll Event EPOLLHUP/EPOLLER&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">error</span><span class="p">)</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;[FD %i] Epoll Event FORCE CLOSE | ret = %i&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">close</span><span class="p">)</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Check timeouts and update next one */</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">log_current_utime</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">fds_timeout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mk_sched_check_timeouts</span><span class="p">(</span><span class="n">sched</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fds_timeout</span> <span class="o">=</span> <span class="n">log_current_utime</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">timeout</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Sometimes a socket may need to be put into sleep because it needs to wait for some
resources, that is, epoll will not monitor any events for this socket, and the socket
will be waked up when the resources are ready and restored to its state before sleeping.
For this reason, a worker thread needs to maintain some extra information for every
socket that is registered to the its epoll instance. The structure is defined as
<code>epoll_state</code> (<code>mk_epoll.h</code>):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'> <span class="o">*</span> <span class="n">An</span> <span class="n">epoll_state</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">the</span> <span class="n">descriptor</span> <span class="n">from</span>
</span><span class='line'> <span class="o">*</span> <span class="n">a</span> <span class="n">Monkey</span> <span class="n">core</span> <span class="n">point</span> <span class="n">of</span> <span class="n">view</span><span class="p">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">struct</span> <span class="n">epoll_state</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span>          <span class="n">fd</span><span class="p">;</span>            <span class="cm">/* File descriptor                    */</span>
</span><span class='line'><span class="kt">uint8_t</span>      <span class="n">mode</span><span class="p">;</span>          <span class="cm">/* Operation mode                     */</span>
</span><span class='line'><span class="kt">uint32_t</span>     <span class="n">events</span><span class="p">;</span>        <span class="cm">/* Events mask                        */</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">behavior</span><span class="p">;</span>      <span class="cm">/* Triggered behavior                 */</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">rb_node</span> <span class="n">_rb_head</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>All the <code>epoll_state</code> are linked together as a reb-black tree for quick access
and modification. For the same sake of reducing overhead, the <code>epoll_state</code>
nodes are pre-allocated and maintained by two queues: an available queue and a
busy queue, it is similar to the ones of <code>sched_connection</code>, <code>epoll_state_index</code>
(<code>mk_epoll.h</code>) plays the role of managing these nodes:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">epoll_state_index</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">rb_root</span> <span class="n">rb_queue</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">busy_queue</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="n">av_queue</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>After all the requests of a socket are successfully processed or some errors
occur on that socket, the socket will be deleted from the epoll instance and the
corresponding <code>epoll_state</code> will be removed from the <code>epoll_state_index</code> tree it
belongs to.</p>

<h2>Clock<a id='clock'></a></h2>

<p>Clock is important for a web server as both log and HTTP header rely on the correctness
of it. Monkey spawns an extra thread for timestamp maintaining and updating. The
clock thread maintains two buffers of formatted strings: one is used by the logger
thread of Monkey and the other one is used by HTTP worker threads to set header
fields for sending back to clients.</p>

<p><img src="/images/blog/clock.jpg" title="&lsquo;Clock&rsquo; &lsquo;Figure 5-1 Clock&rsquo;" ></p>

<p>If you explore <code>mk_clock.h</code>, you can easily find out two <code>mk_pointer</code>s that refer
to the log and HTTP header formatted strings, which are very self-explanatory:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="n">mk_pointer</span> <span class="n">log_current_time</span><span class="p">;</span>     <span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">used</span> <span class="n">by</span> <span class="n">logger</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">extern</span> <span class="n">mk_pointer</span> <span class="n">header_current_time</span><span class="p">;</span>  <span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">used</span> <span class="n">by</span> <span class="n">HTTP</span> <span class="n">workers</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The main loop of clock worker thread is pretty simple: it just update both buffers
every second:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">cur_time</span> <span class="o">!=</span> <span class="p">((</span><span class="kt">time_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mk_clock_log_set_time</span><span class="p">(</span><span class="n">cur_time</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mk_clock_header_set_time</span><span class="p">(</span><span class="n">cur_time</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* update every second */</span>
</span><span class='line'><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Everything just seems fine, but there&rsquo;s a pitfall: what if a thread (either a logger
thread or an HTTP worker thread) access the buffers when they are being updated?
We may get the improper formatted string results!</p>

<p>So, what shall we do? One idea is to use mutex lock, lock the buffers before they
are updated and release the lock after the update is finished. As Monkey emphasizes
on efficiency, we want to avoid using locks whenever it is possible. Luckily we
do get a better solution for it by using a simple trick: use double buffers for
updating. Taken <code>log_current_time</code> as an example, Monkey allocates a string array
of size 2 and uses one element for logger thread accessing and updates the other
array element with new formatted string. In the end of the update, <code>log_current_time</code>
will refer to the newly updated array element:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">define</span> <span class="kt">double</span> <span class="n">buffers</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">log_time_buffers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">The</span> <span class="n">mk_pointers</span> <span class="n">have</span> <span class="n">two</span> <span class="n">buffers</span> <span class="k">for</span> <span class="n">avoid</span> <span class="n">in</span> <span class="n">half</span><span class="o">-</span><span class="n">way</span> <span class="n">access</span> <span class="n">from</span>
</span><span class='line'> <span class="o">*</span> <span class="n">another</span> <span class="kr">thread</span> <span class="k">while</span> <span class="n">a</span> <span class="n">buffer</span> <span class="n">is</span> <span class="n">being</span> <span class="n">modified</span><span class="p">.</span> <span class="n">The</span> <span class="n">function</span> <span class="n">below</span> <span class="n">returns</span>
</span><span class='line'> <span class="o">*</span> <span class="n">one</span> <span class="n">of</span> <span class="n">two</span> <span class="n">buffers</span> <span class="n">to</span> <span class="n">work</span> <span class="n">with</span><span class="p">.</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">_next_buffer</span><span class="p">(</span><span class="n">mk_pointer</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buffers</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="cm">/* get the array element for updating */</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">pointer</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">data</span> <span class="o">==</span> <span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buffers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">update</span> <span class="n">the</span> <span class="n">string</span> <span class="n">buffer</span> <span class="n">used</span> <span class="n">by</span> <span class="n">logger</span> <span class="kr">thread</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">mk_clock_log_set_time</span><span class="p">(</span><span class="kt">time_t</span> <span class="n">utime</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kt">char</span> <span class="o">*</span><span class="n">time_string</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">tm</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">time_string</span> <span class="o">=</span> <span class="n">_next_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">log_current_time</span><span class="p">,</span> <span class="n">log_time_buffers</span><span class="p">);</span>
</span><span class='line'><span class="n">log_current_utime</span> <span class="o">=</span> <span class="n">utime</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* update the array element that is not currently in use */</span>
</span><span class='line'><span class="n">strftime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="n">LOG_TIME_BUFFER_SIZE</span><span class="p">,</span> <span class="s">&quot;[%d/%b/%G %T %z]&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">localtime_r</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">result</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* update the pointer to the newer formatted string */</span>
</span><span class='line'><span class="n">log_current_time</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">time_string</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Hooks<a id='hooks'></a></h2>

<h2>HTTP Requests and Responses<a id='http'></a></h2>

<ul>
<li><h3>HTTP Header</h3></li>
<li><h3>Header Cache</h3></li>
<li><h3>MIME Type</h3></li>
<li><h3>HTTP Method</h3></li>
<li><h3>Connection Management</h3></li>
</ul>


<h2>API Exposure<a id='api'></a></h2>

<h2>Plugins<a id='plugins'></a></h2>

<ul>
<li><h3>Logger</h3></li>
<li><h3>Cheetah</h3></li>
<li><h3>Liana</h3></li>
</ul>


<h2>Appendix<a id='appendix'></a></h2>

<ul>
<li>Monkey source code structure:</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tree
</span><span class='line'>.
</span><span class='line'>|&mdash; include
</span><span class='line'>|   |&mdash; mk_env.h         [contains environment variables, generated by configure file]
</span><span class='line'>|   |&mdash; mk_http_status.h [defines HTTP status codes]
</span><span class='line'>|   |&mdash; mk_info.h        [contains released information]
</span><span class='line'>|   |&mdash; mk_limits.h      [defines upper limit of server]
</span><span class='line'>|   |&mdash; mk_list.h        [contains linked list implementation]
</span><span class='line'>|   |&mdash; mk_macros.h      [contains some handy helper macros]
</span><span class='line'>|   |&mdash; MKPlugin.h       [code that related to Monkey API exposure]
</span><span class='line'>|   &lt;code>-- *.h              [omitted header files that have corresponding c files below]
</span><span class='line'>|-- mk_cache.c           [allows Monkey to cache HTTP headers]
</span><span class='line'>|-- mk_clock.c           [code for Monkey's inner clock]
</span><span class='line'>|-- mk_config.c          [code related to configuration management]
</span><span class='line'>|-- mk_connection.c      [code related to HTTP connections management]
</span><span class='line'>|-- mk_epoll.c           [integrates epoll for fd monitoring and event management]
</span><span class='line'>|-- mk_file.c            [code for retrieving file information]
</span><span class='line'>|-- mk_header.c          [HTTP header management]
</span><span class='line'>|-- mk_http.c            [code related to HTTP lifecycle]
</span><span class='line'>|-- mk_iov.c             [code for scatter/gather I/O]
</span><span class='line'>|-- mk_lib.c             [code related to shared library support]
</span><span class='line'>|-- mk_memory.c          [memory management]
</span><span class='line'>|-- mk_method.c          [HTTP method parse helper]
</span><span class='line'>|-- mk_mimetype.c        [HTTP mimetype management]
</span><span class='line'>|-- mk_plugin.c          [code that powers Monkey's plugin mechanism]
</span><span class='line'>|-- mk_rbtree.c          [contains red-black tree implementation]
</span><span class='line'>|-- mk_request.c         [in charge of HTTP requests and responses handling]
</span><span class='line'>|-- mk_scheduler.c       [scheduler for load balancing]
</span><span class='line'>|-- mk_server.c          [code related to server establishment]
</span><span class='line'>|-- mk_signals.c         [code for signals handling]
</span><span class='line'>|-- mk_socket.c          [socket manipulation utilities]
</span><span class='line'>|-- mk_string.c          [string manipulation utilities]
</span><span class='line'>|-- mk_user.c            [code for uid/pid convertion]
</span><span class='line'>|-- mk_utils.c           [contains some handy helper]
</span><span class='line'>&lt;/code>&mdash; monkey.c             [main entry point of Monkey]</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>Useful utilities for analysing:</li>
</ul>


<p>Here are some tools I found very helpful while analysing source code, this is for
your reference only and please consult man pages for full infomatioin. (If you
use other cool tools, please let me know):</p>

<h3><a href="http://en.wikipedia.org/wiki/CURL">curl</a></h3>

<p><code>curl</code> is a command line tool for transferring data with URL syntax using various
protocols. As with Monkey, I use <code>curl</code> as an HTTP client to communicate with the
Monkey server.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/&lt;em> retrieve the main page from Monkey server &lt;/em>/
</span><span class='line'>curl localhost:2001
</span><span class='line'>/&lt;em> same as above but with verbose information &lt;/em>/
</span><span class='line'>curl -v localhost:2001</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>With this command I can fire a HTTP request without opening my Firefox/Chromium,
it is also much light weight than a comprehensive browser.</p>

<h3><a href="http://en.wikipedia.org/wiki/Netcat">netcat</a></h3>

<p><code>netcat</code> is a computer networking service for reading from and writing to network
connections using TCP or UDP. It is often referred as the swiss army knife for
TCP/IP.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/&lt;em> test timeout &lt;/em>/
</span><span class='line'>date; netcat -C 127.0.0.1 2001; date
</span><span class='line'>/&lt;em> manually send an HTTP request &lt;/em>/
</span><span class='line'>netcat -C 127.0.0.1 2001
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: localhost:2001&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Note: option <code>-C</code> make <code>netcat</code> to use CRLF for EOL sequence, the last blank line
of HTTP request header is required since that means the end of the request.</p>

<p>With this command I can explore a request to Monkey in a lower level than <code>curl</code>,
it helps to understand the TCP connection of Monkey.</p>

<h3><a href="http://en.wikipedia.org/wiki/Lsof">lsof</a></h3>

<p><code>lsof</code> stands for list open files. As we know, one of the most important abstraction
of Linux is files: regular file, pipe, fifo, device, etc. For this reason, <code>lsof</code>
becomes a very neat and invaluable tools, it&rsquo;s the swiss army knife for examining
open files.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/&lt;em> list all the files open by Monkey &lt;/em>/
</span><span class='line'>lsof -c monkey</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>With this command I can be informed which plugins(saved as dynamic library) are
loaded by Monkey and where they reside in the file system, how many pipes are
opened for logging, which socket is used for waiting new incoming connections,
etc.</p>

<h3><a href="http://en.wikipedia.org/wiki/Tcpdump">tcpdump</a></h3>

<p><code>tcpdump</code> is a common packet analyzer that allows the user to intercept and display
TCP/IP and other packets being transmitted or received over a network to which
the computer is attached.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/&lt;em> for our interest, we want to capture packets related to Monkey &lt;/em>/
</span><span class='line'>sudo tcpdump -i lo port 2001</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>With this command I can figure out how every single byte is exchange between Monkey
server and the client.</p>

<p>Note: I am testing Monkey in local mode and thus the interface option is specified
as <code>lo</code>, you should change it to the appropriate interface(<code>eth0</code>, etc.) if the
client and server aren&rsquo;t in the same computer.</p>

<h3><a href="http://en.wikipedia.org/wiki/Htop">htop</a></h3>

<p><code>htop</code> is an interactive system-monitor process-viewer that aims to replace <code>top</code>.
Once you are used to <code>htop</code>, you will never want to go back to <code>top</code>.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>htop</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Within <code>htop</code>, press <code>F4</code> then enter keyword <code>monkey</code> to filt out threads that
belong to Monkey. On my Linux box, the cunstom thread names are not displayed
by default. If this is the same case for you, you can change this behaviour by
the following steps:</p>

<ul>
<li>press <code>F2</code> to enter the setup panel of <code>htop</code></li>
<li>navigate to <code>Display options</code> section</li>
<li>toggle options <code>Show custom thread names</code> on</li>
<li>press <code>F10</code> and you are done</li>
</ul>


<p>With this command I can explore the internal structure of Monkey, check out how
many resources are consumed by Monkey, send signals to Monkey:</p>

<ul>
<li>press <code>l</code> to display output of <code>lsof</code> within <code>htop</code></li>
<li>press <code>s</code> to display output of <code>strace</code> within <code>htop</code></li>
<li>press <code>F5</code> or <code>t</code> to display the process and thread hierarchy of Monkey</li>
<li>press <code>F6</code> or <code>&gt;</code> to sort by time, CPU usage, etc.</li>
</ul>

]]></content>
  </entry>
  
</feed>
