
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Monkey HTTP Daemon Internals - swpd.me</title>
	<meta name="author" content="swpd">

	
	<meta name="description" content="Table of Contents Introduction
Basic Data Structures
Brief Workflow
Configuration
Scheduler
Clock
Hooks
HTTP Requests and Responses
API Exposure &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="swpd.me" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">swpd.me</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:swpd.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/swpdtz" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/swpd" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:swpd.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Monkey HTTP Daemon Internals</h2>
	<div class="entry-content"><p><img src="/images/blog/monkey.jpg" title="Go! Monkey!" alt="Go! Monkey!"></p>

<h2>Table of Contents</h2>

<ul>
<li><a href="#intro">Introduction</a></li>
<li><a href="#data">Basic Data Structures</a></li>
<li><a href="#workflow">Brief Workflow</a></li>
<li><a href="#config">Configuration</a></li>
<li><a href="#sched">Scheduler</a></li>
<li><a href="#clock">Clock</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#http">HTTP Requests and Responses</a></li>
<li><a href="#api">API Exposure</a></li>
<li><a href="#plugins">Plugins</a></li>
<li><a href="#appendix">Appendix</a></li>
</ul>


<h2>Introduction<a id='intro'></a></h2>

<p><a href="http://monkey-project.com">Monkey HTTP Daemon</a> is a web server that aims to get
the most out of the Linux platform. It comes with low resource comsumption and
great scalability which makes it a perfect solution for embedded devices.</p>

<p>Due to the compact size of Monkey&rsquo;s codebase, it is a proper place for revealing
the internals of a event-driven HTTP web server. Spending some time on analysing
the source code of Monkey will surely worth the cost.</p>

<p>This post is about the internals of Monkey&rsquo;s critical components from the
perspective of source code, you may consider it as a supplement of <a href="http://edsiper.linuxchile.cl/blog/2013/02/27/architecture-of-a-linux-based-web-server/">this
post</a>
(written by the author of Monkey). You are supposed to read it first to get a
general view of Monkey.</p>

<p><strong>Notice</strong>: This post is based on Monkey 1.2.0, you may want to get the latest code.
(check out <a href="http://monkey-project.com">home page</a> for more information). If you
are using an older version, there might be something different, e.g. red-black
tree is introduced since version 1.2.0.</p>

<!-- more -->


<h2>Basic Data Structures<a id='data'></a></h2>

<p>This section discusses some common data structures used in Monkey. It is relatively
independent and fundamental so I put it as first.</p>

<ul>
<li><h3>Circular Doubly Linked List</h3></li>
</ul>


<p>Linked List is heavily used within Monkey&rsquo;s source code. It is used to maintain
a list of given structures.</p>

<p>The definition of List is given by <code>mk_list.h</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">mk_list</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty simple and straight forward. But wait for a minute, where is the payload
of a list node? Aha, the list used in Monkey is like the one used in Linux kernel.
The payload of a list node is not held inside the <code>mk_list</code> structure, on the
contrary a list node is embedded in a <em>host structure</em> (see Figure 1-1).</p>

<p><img src="/images/blog/linked-list.png" title="Circular Doubly Linked List" alt="Figure 1-1 Circular Doubly Linked List"></p>

<p>Taken <code>mk_config_entry</code> structure(from <code>mk_config.h</code>) as an example, it contains
a <code>mk_list</code> which is used to connect configuration entries together:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">mk_config_entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may have noticed, there&rsquo;s an extra <code>mk_list</code> in Figure 1-1 that acts as a
sentinel node. This convention simplifies list handling by ensuring that the list
always has a <em>first</em> and <em>last</em> node(even with a empty list). When initializing a
list, Monkey takes a sentinel node and set its <code>prev</code> and <code>next</code> fields to point
to the node itself:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mk_list_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'>    <span class="n">list</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Besides some common list processing functions, there are some handy macros for
list manipulation(<code>mk_config.h</code>):</p>

<p><code>mk_list_foreach(curr, head)</code>: iterate a given list and do something with every
node of the list. <code>curr</code> is a temporary <code>mk_list</code> pointer used to hold the current
visited node. <code>head</code> is the pointer to the head of the given list.</p>

<p><code>mk_list_foreach_safe(curr, n, head)</code>: iterate a given list and do some delete
operation to the node of the list. <code>curr</code> is a temporary <code>mk_list</code> pointer used to
hold the current visited node. Another <code>mk_list</code> temporary pointer <code>n</code> is needed to
retrieve the next node of <code>curr</code> in advance because <code>curr</code> is no longer exists
before the next iteration. <code>head</code> is the pointer to the head of the given list.</p>

<p><code>mk_list_entry(ptr, type, member)</code>: get the start address of a <em>host structure</em>
of a given list node. <code>ptr</code> is a pointer to a given <code>mk_list</code> node. <code>type</code> is the
type of the <em>host structure</em>. <code>member</code> is the name of <code>mk_list</code> field within the
<em>host structure</em>.</p>

<p>Example Usage:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * assume the type of host structure is banana</span>
</span><span class='line'><span class="cm"> * struct banana {</span>
</span><span class='line'><span class="cm"> *     ...</span>
</span><span class='line'><span class="cm"> *     mk_list _head;</span>
</span><span class='line'><span class="cm"> * };</span>
</span><span class='line'><span class="cm"> * monkey loves bananas :D</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">banana</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mk_list_foreach</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">bananas</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">mk_list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">banana</span><span class="p">,</span> <span class="n">_head</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* do something with b */</span>
</span><span class='line'>    <span class="n">wash</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">mk_list_foreach_safe</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">bananas</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">mk_list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">banana</span><span class="p">,</span> <span class="n">_head</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* delete from the list */</span>
</span><span class='line'>    <span class="n">mk_list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">_head</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* do some delete operation */</span>
</span><span class='line'>    <span class="n">eat</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><h3>String</h3></li>
</ul>


<p>String is the most common data structure used in Monkey, and how it is represented
will affect the efficiency and size of Monkey. As we know, the major target of
Monkey is embedded devices so every byte counts.</p>

<p>There are two types of string representation used in Monkey, one is the native
<code>char *</code>(a.k.a. null-terminated) and the other one is defined as <code>mk_pointer</code>
(<code>mk_memory.h</code>):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">mk_pointer</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main difference between them is: the string that referred by one <code>mk_pointer</code>
may also be shared by other <code>mk_pointer</code>(see Figure 1-2) while a <code>char *</code> string
normally have a standalone copy.</p>

<p>By using <code>mk_pointer</code> we can save some memory allocation and release by reusing
the same string. This technique can also reduce memory usage and make Monkey more
compact.</p>

<p><img src="/images/blog/pointer.png" title="String used by multi mk_pointer" alt="Figure 1-2 String used by multi mk_pointer"></p>

<p>When we need to make some change to a given string that is shared by some
<code>mk_pointer</code>, we may not manipulate in the origin string, instead we duplicate a
separate copy. Otherwise it may change some <code>mk_pointer</code> silently which can lead
to unexpected result. <code>char *mk_pointer_to_buf(mk_pointer p)</code> is responsible for
this job. It takes a <code>mk_pointer</code> as input and return a newly allocated string,
the caller shall free the string after use.</p>

<ul>
<li><h3>Red-Black Tree</h3></li>
</ul>


<p>Searching is a common task for almost every program. In Monkey, we will need to
look up the relative information frequently given a socket file descriptor. If
we used list to organize our data, we can only do a linear search because list is
out of order.</p>

<p>In the worst case(the one we are looking for is the last), we need to travel
through the whole list. This is an O(N) operation and as list size increases
this maybe unacceptable for a high performance web server. And this is why
reb-black tree is introduced into Monkey.</p>

<p>If you are unfamiliar with red-black tree, it is time to pick up your undergraduate
data structure textbook and have a quick review. Or alternatively you may refer
to <a href="http://en.wikipedia.org/wiki/Red%E2%80%93black_tree">wikipedia</a> for introduction.</p>

<p><img src="/images/blog/rbtree.png" title="Red-Black Tree" alt="Figure 1-3 Red-Black Tree"></p>

<p>The definition of red-black tree is given by <code>mk_rbtree.h</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">rb_node</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">rb_parent_color</span><span class="p">;</span>
</span><span class='line'><span class="cp">#define  RB_RED      0</span>
</span><span class='line'><span class="cp">#define  RB_BLACK    1</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))));</span>
</span><span class='line'>    <span class="cm">/* The alignment might seem pointless, but allegedly CRIS needs it */</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with <code>mk_list</code>, an <code>mk_rbtree</code> node is also embedded in a <em>host structure</em>.</p>

<h2>Brief Workflow<a id='workflow'></a></h2>

<p>Before we dive into the nitty-gritty of Monkey, it is helpful to walk through the
main function(<code>monkey.c</code>) to get a first impression of Monkey.</p>

<p><img src="/images/blog/bootup.jpg" title="Monkey Bootup" alt="Figure 2-1 Money Bootup">
Main function demonstrates the workflow of Monkey in a high level view:</p>

<ul>
<li>As most traditional Unix program, Monkey starts with parsing command line
options, the options are all very self-explained. Use <code>monkey -h</code> to get full
description of options.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;DSvhp:w:c:&quot;</span><span class="p">,</span> <span class="n">long_opts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="sc">&#39;v&#39;</span>:
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>After parsing options Monkey sets up signal handlers for its interesting signals
and leave others as default (<code>mk_signals.c</code>).</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_signals_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey builds a configuration for itself, some entries of the configuration may
be overrided by the previous parsed options. For more details of the building
process please refer to <em><a href="#config">Configuration</a></em> section.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_config_start_configure</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey allocates an array <code>sched_list</code> of type <code>sched_list_node</code>(defined in
<code>mk_scheduler.h</code>) for worker management. For example, when choosing a worker to
handle a new user request, Monkey&rsquo;s scheduler uses the information maintained by
<code>sched_list</code>.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_sched_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey starts to load the plugins enabled by user and read extra plugin
configurations. For more details of plugins please refer to <em><a href="#plugins">Plugins</a></em>
section.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_plugin_init</span><span class="p">();</span>
</span><span class='line'><span class="n">mk_plugin_read_config</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey creates listening socket and binds it to default port <code>2001</code>(if not
overrided).</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Server listening socket */</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">server_fd</span> <span class="o">=</span> <span class="n">mk_socket_server</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">serverport</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">listen_addr</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey process will turn into a daemon if it is started in daemon mode.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Running Monkey as daemon */</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">is_daemon</span> <span class="o">==</span> <span class="n">MK_TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mk_utils_set_daemon</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey then creates a pid file(<code>logs/monkey.pid.2001</code> by default) which contains
the process identification number (pid) of itself. Pid file is used for
administrating Monkey later.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Register PID of Monkey */</span>
</span><span class='line'><span class="n">mk_utils_register_pid</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey sets the timestamp of when it is started and set up two formatted human
readable time strings, one is for logger and the other is for HTTP response headers.
This must be done before any threads are created, otherwise some thread may
execute before the start time recorded by Monkey.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Clock init that must happen before starting threads */</span>
</span><span class='line'><span class="n">mk_clock_sequential_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Once timestamp is set, Monkey can start the clock thread. The clock thread will
run in an infinite loop and update the two time strings mentioned above per second.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_utils_worker_spawn</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">mk_clock_worker_init</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey creates some thread specific keys for later use by HTTP workers, such as
<code>worker_sched_node</code> for scheduling client connections, etc.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Init thread keys */</span>
</span><span class='line'><span class="n">mk_thread_keys_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>If Monkey is started by root user, it will set the uid/gid to the user specified
in configuration.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Change process owner */</span>
</span><span class='line'><span class="n">mk_user_set_uidgid</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Check if the effective user of Monkey can set the <code>O_NOATIME</code> flag for file accessing.
If so, Monkey will request Linux not to update the last access time on the file.
Updating last access time makes hardly any sence as normally a web server just
send the contents of files requested by clients back.  This will improve Monkey&rsquo;s
performance because we can save a lot of time for very often accessed files.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_config_sanity_check</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey invokes process hooks(<code>PRCTX</code>) of all the plugins, this is useful for
plugins to set up something before entering the main infinite loop. For example,
a plugin may require Monkey to spawn an independent thread for it.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Invoke Plugin PRCTX hooks */</span>
</span><span class='line'><span class="n">mk_plugin_core_process</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey spawns HTTP worker threads for HTTP requests handling. The number of
workers is specified in configuration, if the number is 0 Monkey will spawn HTTP
workers depending on the cores of your CPU(one worker per core).</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Launch monkey http workers */</span>
</span><span class='line'><span class="n">mk_server_launch_workers</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey waits for all HTTP worker threads to be ready by checking the <code>initialized</code>
field of all worker schedule nodes(<code>sched_list_node</code>) every 10 milliseconds. The
mutex lock <code>mutex_worker_init</code> is used to synchronize the status of workers, this
ensures the status of workers won&rsquo;t change during the checking process. Once all
threads are marked as ready the mutex lock is no longer necessary, making the
following server loop lock-free.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Wait until all workers report as ready */</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_worker_init</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">workers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">initialized</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ready</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_worker_init</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">workers</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* wait for 10 milliseconds */</span>
</span><span class='line'>    <span class="n">usleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Monkey enters the main loop of server(<code>mk_server.c</code>), starts listening for
incoming sockets and then dispatches them to workers for processing. From now on,
Monkey is good and ready! It will keep serving requests until you tell it to exit.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mk_server_loop</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">server_fd</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Configuration<a id='config'></a></h2>

<p>Configuration makes Monkey easier to tweak and more flexible, this section will
demonstrate how Monkey deal with it.</p>

<ul>
<li><h3>Configuration File Format</h3></li>
</ul>


<p>Monkey uses a hunman readable file format for configuration, the file is
line-oriented and uses indent level for hierarchy. Figure 3-1 shows the hierarchy
of a configuration file. Within the file there are one or more <em>sections</em>, under
every section there are one or more <em>entries</em>. Besides these there are comments,
comments are lines that start with sharp mark(<code>#</code>).</p>

<p><img src="/images/blog/config.png" title="Configuration File Format" alt="Figure 3-1 Configuration File Format"></p>

<p>A section groups some relative entries for certain subject, and an entry represents
a key-value pair. Section sould be surrounded by brackets(<code>[]</code>) and every entry&rsquo;s
key and value are separated by a whitespace. Monkey comes with comprehensive
configuration documentation, you may want to check out <code>conf/monkey.conf</code> for more
details about how every entry affect Monkey&rsquo;s behaviour.</p>

<ul>
<li><h3>File to Memory Mapping</h3></li>
</ul>


<p>Before Monkey starts serving, it first parse some configuration files to construct
corresponding structures(<code>mk_config</code>, defined in <code>mk_config.h</code>) that resides in
memory. Once parse is finished, Monkey can speed up configuration information
accessing by reading directly from memory.</p>

<p>For every hierarchy level of a Monkey configuration file, there is a mapping
structure in <code>mk_config.h</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *          hierarchy level mapping</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * configuration file      ===&gt;    mk_config</span>
</span><span class='line'><span class="cm"> * section                 ===&gt;    mk_config_section</span>
</span><span class='line'><span class="cm"> * entry(key-value pair)   ===&gt;    mk_config_entry</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">created</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* list of sections */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">sections</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config_section</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* list of entries */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">entries</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">mk_config_entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>A bunch of functions(in <code>mk_config.c</code>) are used for handling configuration file:</p>

<p><code>mk_config_create</code>: given the location of a configuration file, allocate a brand
new <code>mk_config</code>. For every section found in the file allocate a <code>mk_config_section</code>
and for every entry allocate a <code>mk_config_entry</code>.  All the <code>mk_config_section</code> are
linked together as a linked list, the <code>sections</code> field of <code>mk_config</code> serves as the
sentinel node of the list and every <code>_head</code> field of <code>mk_config_section</code> is a
list node. The relation between <code>entries</code> field of <code>mk_config_section</code> and <code>_head</code>
field of <code>mk_config_entry</code> are likewise.</p>

<p><code>mk_config_section_add</code>: add a <code>mk_config_section</code> to the section list of a
specified <code>mk_config</code>. Used by <code>mk_config_create</code> to construct section list.</p>

<p><code>mk_config_section_get</code>: given a section name, find the pointer to the corresponding
<code>mk_config_section</code>.</p>

<p><code>mk_config_entry_add</code>: add a <code>mk_config_entry</code> to the entry list of a specified
<code>mk_config_section</code>. Used by <code>mk_config_create</code> to construct entry list.</p>

<p><code>mk_config_section_getval</code>: given a <code>mk_config_section</code> and a key, find the entry
matching the key under the section. If an entry is found, return its value field,
otherwise return <code>NULL</code>. There are several types of entry value: string, number,
boolean and list. We need to specify which type will the value be interpreted,
and Monkey will parse the value string to correct type for us, the type codes is
defined as follows(<code>mk_config.h</code>):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define MK_CONFIG_VAL_STR 0</span>
</span><span class='line'><span class="cp">#define MK_CONFIG_VAL_NUM 1</span>
</span><span class='line'><span class="cp">#define MK_CONFIG_VAL_BOOL 2</span>
</span><span class='line'><span class="cp">#define MK_CONFIG_VAL_LIST 3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example Usage:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mk_config_section_getval</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s">&quot;Port&quot;</span><span class="p">,</span> <span class="n">MK_CONFIG_VAL_NUM</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>mk_config_error</code>: raise configuration parsing error message and exit Monkey.</p>

<p><code>mk_config_free</code>: free all the allocated resource for a specified <code>mk_config</code>.</p>

<p><code>mk_config_free_entries</code>: free all the allocated resource for a specified
<code>mk_config_section</code>.</p>

<ul>
<li><h3>Virtual Hosting Configuration</h3></li>
</ul>


<p>Monkey supports virtual hosting, which makes it possible for a single server to
host separate host names and share resources among these hosts. For more detailed
introduction please refer to Monkey&rsquo;s <a href="http://monkey-project.com/documentation/virtual_hosts">documentation</a>.</p>

<p>Monkey requires every virtual host to have an independent host configuration file
and all the entries are under a single section <code>[HOST]</code>. All the host configuration
files are under <code>conf/sites/</code>, by default, there is only a file named <code>default</code>.
Every host is represented as a <code>host</code> structure within Monkey(<code>mk_config.h</code>):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">host</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>                   <span class="cm">/* configuration file location*/</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">server_names</span><span class="p">;</span>  <span class="cm">/* host names (a b c...) */</span>
</span><span class='line'>    <span class="n">mk_pointer</span> <span class="n">documentroot</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">host_signature</span><span class="p">;</span>
</span><span class='line'>    <span class="n">mk_pointer</span> <span class="n">header_host_signature</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>     <span class="cm">/* source configuration */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">error_pages</span><span class="p">;</span>   <span class="cm">/* custom error pages */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>         <span class="cm">/* link node */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>file</code> denotes the host file location of current <code>host</code>, <code>server_names</code> is a list
of host names(every host name is a <code>host_alias</code>), <code>documentroot</code> is the document
directory path that is treated by current <code>host</code> as root directory,
<code>host_signature</code> stores the web server name of current <code>host</code>, <code>header_host_signature</code>
is similar to <code>host_signature</code> except that it is formatted as a HTTP header field,
<code>config</code> is undoubtedly the memory mapping of the host configuration file,
<code>error_pages</code> is a list of pages to be displayed when certain HTTP error is
encountered.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Virtual host name , every virtual host may contain one or more of this */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">host_alias</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="cm">/* Custom error page */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">error_page</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">short</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>       <span class="cm">/* HTTP error code */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>             <span class="cm">/* file location relative to documentroot */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">real_path</span><span class="p">;</span>        <span class="cm">/* absolute location of file in the file system */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>All the host configuration information can be found in <code>config</code> field, and why
do we need other fields? There are three reasons for doing so:</p>

<ol>
<li>some fields require further parsing, such as <code>server_names</code> is a list build
from the plain text value of entry <code>Servername</code>.</li>
<li>stores the entry value in a field can make code for retrieving entry value
shorter.</li>
<li>some fields can only be evaluated when Monkey is running.</li>
</ol>


<p>In Monkey we use <code>mk_config_get_host</code> to get a <code>host</code> from a host configuration
file path.</p>

<ul>
<li><h3>Server Configuration</h3></li>
</ul>


<p>Once we gain the necessary knowledge, we can start our journey to Monkey&rsquo;s global
server configuration. The main server configuration is defined in <code>mk_config.h</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="k">struct</span> <span class="n">server_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the <code>server_config</code> structure is a bit larger than anyone we have encountered
so far, thus it is not appropriate to display all the fields of <code>server_config</code>
here and only those really matter will be listed(a reader clever like you can
easily figure out what the rest fields mean by their names :D):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">server_config</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">server_fd</span><span class="p">;</span>                <span class="cm">/* server socket file descriptor */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">worker_capacity</span><span class="p">;</span> <span class="cm">/* how many clients per thread */</span>
</span><span class='line'>    <span class="kt">short</span> <span class="kt">int</span> <span class="n">workers</span><span class="p">;</span>            <span class="cm">/* number of worker threads */</span>
</span><span class='line'>    <span class="kt">int8_t</span> <span class="n">is_daemon</span><span class="p">;</span>             <span class="cm">/* start Monkey as a daemon process */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">serverconf</span><span class="p">;</span>             <span class="cm">/* path to server configuration files */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">listen_addr</span><span class="p">;</span>            <span class="cm">/* address to listen, 0.0.0.0(all) by default */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">pid_file_path</span><span class="p">;</span>          <span class="cm">/* pid of server */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid_status</span><span class="p">;</span>               <span class="cm">/* whether pid file is created */</span>
</span><span class='line'>    <span class="kt">int8_t</span> <span class="n">resume</span><span class="p">;</span>                <span class="cm">/* allow file range(partial contents)? */</span>
</span><span class='line'>    <span class="kt">int8_t</span> <span class="n">symlink</span><span class="p">;</span>               <span class="cm">/* allow symbolic link requests? */</span>
</span><span class='line'>    <span class="kt">int8_t</span> <span class="n">keep_alive</span><span class="p">;</span>            <span class="cm">/* allow persisten connection? */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">max_keep_alive_request</span><span class="p">;</span>   <span class="cm">/* max persistent connections to allow */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">keep_alive_timeout</span><span class="p">;</span>       <span class="cm">/* persistent connection timeout */</span>
</span><span class='line'>    <span class="n">uid_t</span> <span class="n">euid</span><span class="p">;</span>                   <span class="cm">/* effective user id */</span>
</span><span class='line'>    <span class="n">gid_t</span> <span class="n">egid</span><span class="p">;</span>                   <span class="cm">/* effective group id */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">index_files</span><span class="p">;</span>  <span class="cm">/* different index file names */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">hosts</span><span class="p">;</span>         <span class="cm">/* list of virtuals hosts served by Monkey */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="o">*</span><span class="n">plugins</span><span class="p">;</span>      <span class="cm">/* plugins enabled by Monkey */</span>
</span><span class='line'>                                  <span class="cm">/* ...(some omitted fields) */</span>
</span><span class='line'>    <span class="n">mode_t</span> <span class="n">open_flags</span><span class="p">;</span>            <span class="cm">/* flags used to open files that required by clients */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">safe_event_write</span><span class="p">;</span>         <span class="cm">/* safe EPOLLOUT event */</span>
</span><span class='line'>    <span class="cm">/* Transport type: HTTP or HTTPS, useful for redirections */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* Define the plugin which provides the transport layer */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">transport_layer</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">plugin</span> <span class="o">*</span><span class="n">transport_layer_plugin</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* Define the default MIME type when it is not possible to find a proper one */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">default_mimetype</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s take a closer look at how server configuration is built by Monkey:</p>

<ul>
<li><p>As we have seen in the <a href="#workflow"><em>Brief Workflow</em></a> section, Monkey enters server
configuration building process via <code>mk_config_start_configure</code>. Before reading
configuration file into memory, Monkey initializes some fields of <code>server_config</code>
with default values(by calling <code>mk_config_set_init_values</code>).</p></li>
<li><p>Monkey then uses <code>mk_config_read_files</code> to map the server configuration file
into memory(<code>config</code> field of <code>server_config</code>). If an entry is defined in the
file, its default value will be overrided:</p></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* in function `mk_config_set_init_values` */</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="n">MK_TRUE</span><span class="p">;</span>   <span class="cm">/* default value */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* in function `mk_config_read_files` */</span>
</span><span class='line'><span class="cm">/* overrided by configuration file */</span>
</span><span class='line'><span class="n">config</span><span class="o">-&gt;</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">mk_config_section_getval</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s">&quot;KeepAlive&quot;</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">MK_CONFIG_VAL_BOOL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>After the main configuration file is parsed, Monkey starts mapping all the
virtual host configuration files into memory. This is achieved by calling
<code>mk_config_read_hosts</code>, it will go through all the files under <code>conf/sites/</code>(except
<code>.</code>, <code>..</code> and <code>default</code>, <code>default</code> has been read before any virtual hosts) and
construct the corresponding <code>host</code>(<code>mk_config_get_host</code>). All the <code>host</code> are linked
together as a list via the <code>hosts</code> field of <code>server_config</code>.</p></li>
<li><p>Monkey reads the MIME types configuration file(<code>conf/monkey.mime</code>) and stores
all the types in an array for later use. For more details of MIME types please
refer to <a href="#http"><em>HTTP</em></a> section.</p></li>
</ul>


<p>Up to this point, the configuration building process of Monkey is finished.</p>

<h2>Scheduler<a id='sched'></a></h2>

<p>Recall that Monkey spawns several HTTP workers for client requests processing,
one thing we might concern about is how Monkey will schedule a new incoming
connection. With this question in mind, let&rsquo;s dig into Monkey&rsquo;s scheduler strategy
and implementation.</p>

<p>Within Monkey the scheduling unit is abstracted as structure <code>sched_connection</code>
(defined in <code>mk_scheduler.h</code>).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">sched_connection</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>              <span class="cm">/* file descriptor of remote socket */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>              <span class="cm">/* connection status */</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">events</span><span class="p">;</span>         <span class="cm">/* epoll events that Monkey is intereted about */</span>
</span><span class='line'>    <span class="kt">time_t</span> <span class="n">arrive_time</span><span class="p">;</span>      <span class="cm">/* arrived time(when a connection is established) */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">_rb_head</span><span class="p">;</span> <span class="cm">/* red-black tree head(for quick accessing) */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">_head</span><span class="p">;</span>    <span class="cm">/* list head */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>When a client issues a new connection to the Monkey server, a new <code>sched_connection</code>
is allocated. Then Monkey will schedule this connection based on a simple load
balance strategy: find the HTTP worker that holds the least active connections
and dispatch the new connection to it. Although this is a trivial strategy, it
works fine because mostly HTTP request processing and response generating won&rsquo;t
take a long time. But if there is an HTTP request requires enormous amount of
computation, other requests handled by the same worker will wait for a long time
while other workers may be idle.</p>

<p>In order to schedule connections, Monkey needs to keep track of some extra information
of every HTTP worker. For every HTTP worker, there is a associated <code>sched_list_node</code>
(defined in <code>mk_scheduler.h</code>) structure for the sake of maintaining such information:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">sched_list_node</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">accepted_connections</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Red-Black tree queue to perform fast lookup over</span>
</span><span class='line'><span class="cm">     * the scheduler busy queue</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">rb_queue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Available and busy queue */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">busy_queue</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mk_list</span> <span class="n">av_queue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">short</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="cm">/* worker index */</span>
</span><span class='line'>    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span> <span class="cm">/* worker thread id */</span>
</span><span class='line'>    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>     <span class="cm">/* worker process id, thread is just light weight process in Linux */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">epoll_fd</span><span class="p">;</span>  <span class="cm">/* epoll instance for monitoring file descriptors */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">initialized</span><span class="p">;</span> <span class="cm">/* whether this worker has been initialized */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>accepted_connections</code> records the total number of connections accepted and
hanlded by the corresponding worker, and <code>closed_connections</code> records the total
number of connections closed by the corresponding worker. With these two numbers
the active connections of a worker is given by the difference of them:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* the active connection number will never be negative */</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">active_connections</span> <span class="o">=</span> <span class="n">accepted_connections</span> <span class="o">-</span> <span class="n">closed_connections</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>rb_queue</code> refers to the root of a red-black tree that maintains all the active
connections of the corresponding worker according to their file descriptors. The
<code>_rb_head</code> field of active <code>sched_connection</code> serve as tree nodes and are linked
together as a red-black tree.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_next_target</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* calculate the active connections of worker */</span>
</span><span class='line'>    <span class="n">cur</span> <span class="o">=</span> <span class="n">sched_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">accepted_connections</span> <span class="o">-</span> <span class="n">sched_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Finds the worker with lowest load */</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">workers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">accepted_connections</span> <span class="o">-</span> <span class="n">sched_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">closed_connections</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">target</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>            <span class="n">cur</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * If sched_list[target] worker is full then the whole server too, because</span>
</span><span class='line'><span class="cm">     * it has the lowest load.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">mk_unlikely</span><span class="p">(</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">worker_capacity</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MK_TRACE</span><span class="p">(</span><span class="s">&quot;Too many clients: %i&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">worker_capacity</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">workers</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><h3>Epoll</h3></li>
</ul>


<h2>Clock<a id='clock'></a></h2>

<h2>Hooks<a id='hooks'></a></h2>

<h2>HTTP Requests and Responses<a id='http'></a></h2>

<ul>
<li><h3>HTTP Header</h3></li>
<li><h3>Header Cache</h3></li>
<li><h3>MIME Type</h3></li>
<li><h3>HTTP Method</h3></li>
<li><h3>Connection Management</h3></li>
</ul>


<h2>API Exposure<a id='api'></a></h2>

<h2>Plugins<a id='plugins'></a></h2>

<ul>
<li><h3>Logger</h3></li>
<li><h3>Cheetah</h3></li>
<li><h3>Liana</h3></li>
</ul>


<h2>Appendix<a id='appendix'></a></h2>

<ul>
<li>Monkey source code structure:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tree
</span><span class='line'>.
</span><span class='line'>|-- include
</span><span class='line'>|   |-- mk_env.h         [contains environment variables, generated by configure file]
</span><span class='line'>|   |-- mk_http_status.h [defines HTTP status codes]
</span><span class='line'>|   |-- mk_info.h        [contains released information]
</span><span class='line'>|   |-- mk_limits.h      [defines upper limit of server]
</span><span class='line'>|   |-- mk_list.h        [contains linked list implementation]
</span><span class='line'>|   |-- mk_macros.h      [contains some handy helper macros]
</span><span class='line'>|   |-- MKPlugin.h       [code that related to Monkey API exposure]
</span><span class='line'>|   `-- *.h              [omitted header files that have corresponding c files below]
</span><span class='line'>|-- mk_cache.c           [allows Monkey to cache HTTP headers]
</span><span class='line'>|-- mk_clock.c           [code for Monkey's inner clock]
</span><span class='line'>|-- mk_config.c          [code related to configuration management]
</span><span class='line'>|-- mk_connection.c      [code related to HTTP connections management]
</span><span class='line'>|-- mk_epoll.c           [integrates epoll for fd monitoring and event management]
</span><span class='line'>|-- mk_file.c            [code for retrieving file information]
</span><span class='line'>|-- mk_header.c          [HTTP header management]
</span><span class='line'>|-- mk_http.c            [code related to HTTP lifecycle]
</span><span class='line'>|-- mk_iov.c             [code for scatter/gather I/O]
</span><span class='line'>|-- mk_lib.c             [code related to shared library support]
</span><span class='line'>|-- mk_memory.c          [memory management]
</span><span class='line'>|-- mk_method.c          [HTTP method parse helper]
</span><span class='line'>|-- mk_mimetype.c        [HTTP mimetype management]
</span><span class='line'>|-- mk_plugin.c          [code that powers Monkey's plugin mechanism]
</span><span class='line'>|-- mk_rbtree.c          [contains red-black tree implementation]
</span><span class='line'>|-- mk_request.c         [in charge of HTTP requests and responses handling]
</span><span class='line'>|-- mk_scheduler.c       [scheduler for load balancing]
</span><span class='line'>|-- mk_server.c          [code related to server establishment]
</span><span class='line'>|-- mk_signals.c         [code for signals handling]
</span><span class='line'>|-- mk_socket.c          [socket manipulation utilities]
</span><span class='line'>|-- mk_string.c          [string manipulation utilities]
</span><span class='line'>|-- mk_user.c            [code for uid/pid convertion]
</span><span class='line'>|-- mk_utils.c           [contains some handy helper]
</span><span class='line'>`-- monkey.c             [main entry point of Monkey]</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Useful utilities for analysing:</li>
</ul>


<p>Here are some tools I found very helpful while analysing source code, this is for
your reference only and please consult man pages for full infomatioin. (If you
use other cool tools, please let me know):</p>

<h3><a href="http://en.wikipedia.org/wiki/CURL">curl</a></h3>

<p><code>curl</code> is a command line tool for transferring data with URL syntax using various
protocols. As with Monkey, I use <code>curl</code> as an HTTP client to communicate with the
Monkey server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* retrieve the main page from Monkey server */
</span><span class='line'>curl localhost:2001
</span><span class='line'>/* same as above but with verbose information */
</span><span class='line'>curl -v localhost:2001</span></code></pre></td></tr></table></div></figure>


<p>With this command I can fire a HTTP request without opening my Firefox/Chromium,
it is also much light weight than a comprehensive browser.</p>

<h3><a href="http://en.wikipedia.org/wiki/Netcat">netcat</a></h3>

<p><code>netcat</code> is a computer networking service for reading from and writing to network
connections using TCP or UDP. It is often referred as the swiss army knife for
TCP/IP.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* test timeout */
</span><span class='line'>date; netcat -C 127.0.0.1 2001; date
</span><span class='line'>/* manually send an HTTP request */
</span><span class='line'>netcat -C 127.0.0.1 2001
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: localhost:2001</span></code></pre></td></tr></table></div></figure>


<p>Note: option <code>-C</code> make <code>netcat</code> to use CRLF for EOL sequence, the last blank line
of HTTP request header is required since that means the end of the request.</p>

<p>With this command I can explore a request to Monkey in a lower level than <code>curl</code>,
it helps to understand the TCP connection of Monkey.</p>

<h3><a href="http://en.wikipedia.org/wiki/Lsof">lsof</a></h3>

<p><code>lsof</code> stands for list open files. As we know, one of the most important abstraction
of Linux is files: regular file, pipe, fifo, device, etc. For this reason, <code>lsof</code>
becomes a very neat and invaluable tools, it&rsquo;s the swiss army knife for examining
open files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* list all the files open by Monkey */
</span><span class='line'>lsof -c monkey</span></code></pre></td></tr></table></div></figure>


<p>With this command I can be informed which plugins(saved as dynamic library) are
loaded by Monkey and where they reside in the file system, how many pipes are
opened for logging, which socket is used for waiting new incoming connections,
etc.</p>

<h3><a href="http://en.wikipedia.org/wiki/Tcpdump">tcpdump</a></h3>

<p><code>tcpdump</code> is a common packet analyzer that allows the user to intercept and display
TCP/IP and other packets being transmitted or received over a network to which
the computer is attached.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* for our interest, we want to capture packets related to Monkey */
</span><span class='line'>sudo tcpdump -i lo port 2001</span></code></pre></td></tr></table></div></figure>


<p>With this command I can figure out how every single byte is exchange between Monkey
server and the client.</p>

<p>Note: I am testing Monkey in local mode and thus the interface option is specified
as <code>lo</code>, you should change it to the appropriate interface(<code>eth0</code>, etc.) if the
client and server aren&rsquo;t in the same computer.</p>

<h3><a href="http://en.wikipedia.org/wiki/Htop">htop</a></h3>

<p><code>htop</code> is an interactive system-monitor process-viewer that aims to replace <code>top</code>.
Once you are used to <code>htop</code>, you will never want to go back to <code>top</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>htop</span></code></pre></td></tr></table></div></figure>


<p>Within <code>htop</code>, press <code>F4</code> then enter keyword <code>monkey</code> to filt out threads that
belong to Monkey. On my Linux box, the cunstom thread names are not displayed
by default. If this is the same case for you, you can change this behaviour by
the following steps:</p>

<ul>
<li>press <code>F2</code> to enter the setup panel of <code>htop</code></li>
<li>navigate to <code>Display options</code> section</li>
<li>toggle options <code>Show custom thread names</code> on</li>
<li>press <code>F10</code> and you are done</li>
</ul>


<p>With this command I can explore the internal structure of Monkey, check out how
many resources are consumed by Monkey, send signals to Monkey:</p>

<ul>
<li>press <code>l</code> to display output of <code>lsof</code> within <code>htop</code></li>
<li>press <code>s</code> to display output of <code>strace</code> within <code>htop</code></li>
<li>press <code>F5</code> or <code>t</code> to display the process and thread hierarchy of Monkey</li>
<li>press <code>F6</code> or <code>&gt;</code> to sort by time, CPU usage, etc.</li>
</ul>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-05-18T09:21:00+08:00" pubdate data-updated="true">May 18<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/http/'>HTTP</a>, <a class='category' href='/blog/categories/monkey/'>Monkey</a>, <a class='category' href='/blog/categories/source-code/'>Source Code</a>, <a class='category' href='/blog/categories/web-server/'>Web Server</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div>
    <a href="http://www.vim.org/">
        <img src="/images/vim_powered.gif" title="Powered by Vim" alt="Powered by Vim">
    </a>
    <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
        <img src="/images/cc.png" title="Creative Commons" alt="Creative Commons">
    </a>
</div>
Copyright &copy; 2013

    swpd

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'swpdtz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://swpd.github.io/blog/2013/05/18/monkey-http-daemon-internals/';
        var disqus_url = 'http://swpd.github.io/blog/2013/05/18/monkey-http-daemon-internals/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-41181986-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>